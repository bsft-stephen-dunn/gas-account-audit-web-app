<script>
// Additional JavaScript functions that can be included if needed

// Format date to readable string
function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Format number with commas
function formatNumber(num) {
  if (num === null || num === undefined) return 'N/A';
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Debounce function for input events
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Auto-resize textarea
function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
}

// Initialize auto-resize for all textareas
document.addEventListener('DOMContentLoaded', function() {
  const textareas = document.querySelectorAll('.textarea-input');
  textareas.forEach(textarea => {
    // Set initial height
    autoResizeTextarea(textarea);
    
    // Add event listener for input
    textarea.addEventListener('input', function() {
      autoResizeTextarea(this);
    });
  });
});

// Check if running in Google Apps Script environment
function isGoogleAppsScript() {
  return typeof google !== 'undefined' && google.script && google.script.run;
}

// Safe console log that works in GAS
function safeLog(...args) {
  if (typeof console !== 'undefined' && console.log) {
    console.log(...args);
  }
}

// Handle keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + Enter to submit form
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    const activeElement = document.activeElement;
    if (activeElement && activeElement.form) {
      activeElement.form.dispatchEvent(new Event('submit', { cancelable: true }));
    }
  }
  
  // Ctrl/Cmd + K to focus search/site input
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    const siteInput = document.getElementById('siteName');
    if (siteInput) {
      siteInput.focus();
      siteInput.select();
    }
  }
});

// Google Picker functionality
let pickerApiLoaded = false;
let oauthToken;
let selectedFolderId = null;
let selectedFolderName = 'My Drive';

// Load the Google Picker API
function loadPicker() {
  gapi.load('picker', {'callback': onPickerApiLoad});
}

function onPickerApiLoad() {
  pickerApiLoaded = true;
}

// Create and display the folder picker
function createPicker() {
  if (pickerApiLoaded && oauthToken) {
    const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
      .setSelectFolderEnabled(true)
      .setIncludeFolders(true);

    const picker = new google.picker.PickerBuilder()
      .addView(view)
      .setOAuthToken(oauthToken)
      .setCallback(pickerCallback)
      .setTitle('Select a folder to save your audit document')
      .build();
    picker.setVisible(true);
  } else {
    // Get OAuth token from server
    google.script.run
      .withSuccessHandler(function(token) {
        oauthToken = token;
        createPicker();
      })
      .withFailureHandler(function(error) {
        console.error('Error getting OAuth token:', error);
        showMessage('Error loading folder picker. Documents will be saved to My Drive.', 'error');
      })
      .getOAuthToken();
  }
}

// Handle picker selection
function pickerCallback(data) {
  if (data.action === google.picker.Action.PICKED) {
    const doc = data.docs[0];
    selectedFolderId = doc.id;
    selectedFolderName = doc.name;
    
    // Update UI to show selected folder
    const folderDisplay = document.getElementById('selectedFolder');
    if (folderDisplay) {
      folderDisplay.textContent = selectedFolderName;
      folderDisplay.classList.add('folder-selected');
    }
    
    // Show success message
    showSnackbar(`Folder selected: ${selectedFolderName}`);
  }
}

// Initialize Google API
function initGoogleApi() {
  // Load the Google API
  const script = document.createElement('script');
  script.src = 'https://apis.google.com/js/api.js?onload=loadPicker';
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
}

// Export functions for use in main script
window.utilityFunctions = {
  formatDate,
  formatNumber,
  debounce,
  autoResizeTextarea,
  isGoogleAppsScript,
  safeLog
};

// Export picker functions
window.pickerFunctions = {
  initGoogleApi,
  createPicker,
  getSelectedFolder: () => ({ id: selectedFolderId, name: selectedFolderName })
};
</script>